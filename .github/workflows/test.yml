name: test.yml
on:
  push:
   branches: [ master, main, 'sprint/**', 'release/**' ]

  pull_request:
    # By default: opened, synchronize, or reopened
    branches: [ master, main, 'sprint/**', 'release/**' ]

  
  # Manual run by SK

jobs:
  ExampleJob:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
    ##- name: Configure SSH key
     # uses: webfactory/ssh-agent@v0.6.0
     # with: 
      #    ssh-private-key: ${{ secrets.COMCAST_SSH_KEY }}
   # - uses: actions/checkout@v2
    #  with:
     #   ssh-key: "${{ secrets.COMCAST_SSH_KEY }}"
     
  #  - uses: kielabokkie/ssh-key-and-known-hosts-action@v1
   #   with:
    #      ssh-private-key: ${{ secrets.COMCAST_SSH_KEY }}
     #     ssh-host: github.com
     
     
    - name: Add SSH key
      env:
            SSH_AUTH_SOCK: /tmp/ssh_agent.sock
      run: |
            echo "where am I ?"
            pwd
            echo " "
            echo " "
            mkdir -p GITHUB_WORKSPACE/.ssh

            ssh-keyscan github.com >> GITHUB_WORKSPACE/.ssh/known_hosts

            echo "${{ secrets.COMCAST_SSH_KEY }}" > GITHUB_WORKSPACE/.ssh/github_actions
            chmod 600 GITHUB_WORKSPACE/.ssh/github_actions
            
            ssh-agent -a $SSH_AUTH_SOCK > /dev/null   
            ssh-add GITHUB_WORKSPACE/.ssh/github_actions
            ssh-add - <<< "${{ secrets.COMCAST_SSH_KEY }}"
            touch GITHUB_WORKSPACE/.ssh/id_rsa
            echo "$COMCAST_SSH_KEY" | tr -d '\r' > GITHUB_WORKSPACE/.ssh/id_rsa
            chmod 600 GITHUB_WORKSPACE/.ssh/id_rsa
            echo -e "Host *\nStrictHostKeyChecking no\n" > GITHUB_WORKSPACE/.ssh/config
            eval "$(ssh-agent -s)"
            ssh-add - <<< "${{ secrets.COMCAST_SSH_KEY }}"            

      
    - name: Test ssh
      run: |
          #  echo "whats in this directory"
           # ls -ll
           echo "whats in GITHUB_WORKSPACE/.ssh directoy"
           ls -al GITHUB_WORKSPACE/.ssh/
           echo " "
           echo " "
           echo "whats the size runner/.ssh directoy"
           du -hc /home/runner/.ssh/*
           echo " "
           echo " "
           echo "whats in ssh directoy"
           ls -al ~/.ssh
           echo " "
           echo " "   
           echo "what are contents of id_rsa"
           #cat /home/runner/.ssh/id_rsa
           more GITHUB_WORKSPACE/.ssh/id_rsa
           echo " "
           echo " "
           #echo "Whats in comcast_secret_key ?"
           #cat ${{secrets.COMCAST_SSH_KEY}}
           #echo " "
           #echo " "           
           echo "whats in known hosts ?"
           cat GITHUB_WORKSPACE/.ssh/known_hosts
           echo " "
           echo " " 
           # echo "Running ssh command"
           # eval `ssh-agent`
            echo "Running ssh -vT command"
            ssh -vT git@github.com
            #echo "Running ssh-add"
            #ssh-add -l -E sha256
           
      
    - name: Checkout dwrobel
          echo "Checkout dwrobel repo"
      uses: actions/checkout@v3
      with:
          repository: dwrobel/poky
          path: dwrobel
